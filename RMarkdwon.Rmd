---
title: "Group 2"
author: "Ben Aland, Birch Lazo-Murphy, Darcy Perin, Nick Steichmann"
date: "4/14/2022"
output: html_document
---

Individual codes, made figures, description and rationale for analysis.

### Ben's Code
```{r echo = FALSE, warning=FALSE, message=FALSE}
getwd()
Shapefiles_water = st_read("data/SC_Major_River_Basins", "SC_Major_River_Basins")


Shapefiles_stations = st_read("data/bw.SDE.STATIONS", "bw.SDE.STATIONS")

Shapefiles_DHEC_303d = st_read("data/bw.SDE.DHEC_303D_18", "bw.SDE.DHEC_303D_18")

Water_projected = st_transform(Shapefiles_water, crs = 4326)
Stations_projected = st_transform(Shapefiles_stations, crs = 4326)

DHEC_projected = st_transform(Shapefiles_DHEC_303d, crs = 4326)

summary(DHEC_projected)
summary(Shapefiles_DHEC_303d)
summary(Water_projected)
summary(Stations_projected)


lat_bounds = c(31.5, 35.5)
lon_bounds = c(-84, -78)

world_map = map_data("worldHires", ylim= lat_bounds, xlim=lon_bounds)
plot(Water_projected)
plot(Stations_projected)
plot(DHEC_projected)
#initial map visulaization
SC_map = ggplot() +
   geom_sf(data=Water_projected, aes(color="Basin")) +
  geom_sf(data=DHEC_projected, alpha=0.5, aes(color="black"), fill="303D")+
  geom_sf(data=Stations_projected, alpha =0.7, aes(color="STAT")) +
  coord_sf(1.3, xlim = lon_bounds, ylim = lat_bounds)

SC_map
####
#Manipulating Birch's older code as data for map creation
#From Birch
data18 <- read_xls("data/2018303d_final.xls")
data08 <- read_xls("data/SC_303d_lists_2006to2016/2008303dfinal020608prtyrk.xls")
data98 <- read_xls("data/SC_303d_lists_1998to2004/1998303dfin_al_rec_only.xls")

# Stations who FAILED to improve from 1998 to 2008
stationsFail98to08 <- inner_join(data98, data08, by = "STATION")
head(stationsFail98to08)
fail_list = unique(stationsFail98to08$HUC_12)
fail_list
head(Stations_projected)
stationsFail10yr_updated <- #left_join(stationsFail98to08, Stations_projected, by = "HUC_12")
  Stations_projected %>%
  mutate(fail = ifelse(HUC_12 %in% fail_list, TRUE, FALSE))
summary(stationsFail10yr_updated)
stationsFail10yr_updated_2 = stationsFail10yr_updated %>% filter(fail==TRUE)
summary(stationsFail10yr_updated_2)

# Stations who FAILED to improve from 1998 to 2018
stationsFail20yr <- inner_join(stationsFail98to08, data18, by = "STATION")
stationsFail20yr_join <- left_join(stationsFail20yr, Stations_projected, by = "HUC_12")
fail_list_2 = unique(stationsFail20yr$HUC_12)
stationsFail20yr_updated <- 
  Stations_projected %>%
  mutate(fail = ifelse(HUC_12 %in% fail_list_2, TRUE, FALSE))
stationsFail20yr_updated_2 = stationsFail20yr_updated %>% filter(fail==TRUE)
summary(stationsFail20yr_updated_2)



# Stations who got better and were REMOVED from 1998 to 2018
stationsPass20yr <- data18[!data18$STATION %in% stationsFail20yr$STATION,]
stationsPass20yr_join <- left_join(stationsPass20yr, Stations_projected, by = "HUC_12")
pass_list = unique(stationsPass20yr$HUC_12)
stationsPass20yr_updated <- 
  Stations_projected %>%
  mutate(pass = ifelse(HUC_12 %in% pass_list, TRUE, FALSE))
stationsPass20yr_updated_2 = stationsPass20yr_updated %>% filter(pass==TRUE)
summary(stationsPass20yr_updated)

# Stations who were ADDED between 1998 and 2008 
stationsWorse98to08 <- data08[!data08$STATION %in% data98$STATION,]

# Stations who were ADDED between 1998 and 2018
stationsWorse20yr <- data18[!data18$STATION %in% stationsWorse98to08$STATION,]
stationsWorse20yr_join <- left_join(stationsWorse20yr, Stations_projected, by = "HUC_12")

worse_list = unique(stationsWorse20yr$HUC_12)
stationsWorse20yr_updated <- 
  Stations_projected %>%
  mutate(worse = ifelse(HUC_12 %in% worse_list, TRUE, FALSE))
stationsWorse20yr_updated_2 = stationsWorse20yr_updated %>% filter(worse==TRUE)
summary(stationsWorse20yr_updated)


####
#MAPS From Ben
fail20year_map = ggplot() +
   geom_sf(data=Water_projected, aes(color="Basin")) +
  geom_point(data=stationsFail20yr_updated_2, alpha =0.7, aes(x=LONGITUDE, y=LATITUDE, color="SITE")) +
  coord_sf(1.3, xlim = lon_bounds, ylim = lat_bounds)+
  ggtitle("Sites that failed to improve from '98-'18")
fail20year_map


pass20year_map = ggplot() +
   geom_sf(data=Water_projected, aes(color="Basin")) +
  geom_point(data=stationsPass20yr_updated_2, alpha =0.5, aes(x=LONGITUDE, y=LATITUDE, color="SITE")) +
  coord_sf(1.3, xlim = lon_bounds, ylim = lat_bounds)+
  ggtitle("Sites that improved from '98-'18")
pass20year_map

added_stations_map = ggplot() +
   geom_sf(data=Water_projected, aes(color="Basin")) +
  geom_point(data=stationsWorse20yr_updated_2, alpha =0.5, aes(x=LONGITUDE, y=LATITUDE, color="SITE")) +
  coord_sf(1.3, xlim = lon_bounds, ylim = lat_bounds)+
  ggtitle("Sites that were added from '98-'18")
added_stations_map


failures <- stationsFail20yr %>% 
  group_by(LOCATION) %>% 
  summarize(NumCauses=n()) %>%
  filter(NumCauses == 8)
#SUPER FAIL MAP
failures_2 = left_join(failures, stationsFail20yr_join, by="LOCATION")
summary(stationsFail20yr_join)
super_fail_map = ggplot() +
   geom_sf(data=Water_projected, aes(color="Basin")) +
  geom_point(data=failures_2, alpha =0.5, aes(x=LONGITUDE, y=LATITUDE, color="SITE")) +
  coord_sf(1.3, xlim = lon_bounds, ylim = lat_bounds)+
  ggtitle("Sites that were Problematic with 8 Causes")
super_fail_map


```
These maps show the total amount of stations that either failed the water quality tests for a variety (or in some case up to eight) of reasons or passed all the tests and were removed from the list. They also show which sites failed to improve and pass the tests and remained on the fail list for 20 years. The final map shows the stations that failed with 8 different causes for each station. Total amount of stations that failed to improve was staggeringly high at 1102. Total amount of stations that passed were also high at 3540. Stations that went from passing to failing over the 20 year period were totaled at 2894. Four total stations failed with 8 separate causes. 


### Birch's Code
```{r echo = FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(readxl)
library(viridisLite)
library(viridis)

data18 <- read_xls("data/2018303d_final.xls")
data08 <- read_xls("data/SC_303d_lists_2006to2016/2008303dfinal020608prtyrk.xls")
data98 <- read_xls("data/SC_303d_lists_1998to2004/1998303dfin_al_rec_only.xls")

# Stations who FAILED to improve from 1998 to 2008
stationsFail98to08 <- inner_join(data98, data08, by = "STATION")
Failed98to08MoreThanOne <- stationsFail98to08 %>% 
  group_by(LOCATION) %>% 
  summarize(count=n())

# Stations who FAILED to improve from 1998 to 2018
stationsFail20yr <- inner_join(stationsFail98to08, data18, by = "STATION")

# Stations who got better and were REMOVED from 1998 to 2018
stationsPass20yr <- data18[!data18$STATION %in% stationsFail20yr$STATION,]

# Stations who were ADDED between 1998 and 2008 
stationsWorse98to08 <- data08[!data08$STATION %in% data98$STATION,]

# Stations who were ADDED between 1998 and 2018
stationsWorse20yr <- data18[!data18$STATION %in% stationsWorse98to08$STATION,]

# Number of Causes for Each Location that has continuously failed
Failed98to18MoreThanOne <- stationsFail20yr %>% 
  group_by(LOCATION) %>% 
  summarize(NumCauses=n()) %>%
  group_by(NumCauses) %>%
  summarize(count2 = n())
Failed98to18MoreThanOne$NumCauses <- sub("^", "N", Failed98to18MoreThanOne$NumCauses)
Failed98to18MoreThanOne$Percent <- c(Failed98to18MoreThanOne$count2[1]/sum(Failed98to18MoreThanOne$count2)*100,
                                     Failed98to18MoreThanOne$count2[2]/sum(Failed98to18MoreThanOne$count2)*100,
                                     Failed98to18MoreThanOne$count2[3]/sum(Failed98to18MoreThanOne$count2)*100,
                                     Failed98to18MoreThanOne$count2[4]/sum(Failed98to18MoreThanOne$count2)*100,
                                     Failed98to18MoreThanOne$count2[5]/sum(Failed98to18MoreThanOne$count2)*100,
                                     Failed98to18MoreThanOne$count2[6]/sum(Failed98to18MoreThanOne$count2)*100)

ggplot(Failed98to18MoreThanOne, aes(x= "", y=Percent, fill=NumCauses)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  scale_fill_viridis(option = "C", discrete = TRUE) +
  theme_void() +
  labs(title = "Number of Causes for Locations Listed from 1998 to 2018")

# Number of Causes for Each Location that has been removed from the list
Pass98to18MoreThanOne <- stationsPass20yr %>% 
  group_by(DESCRIPTION) %>% 
  summarize(NumCauses=n()) %>%
  na.omit() %>%
  group_by(NumCauses) %>%
  summarize(count2 = n()) 
Pass98to18MoreThanOne$NumCauses <- sub("^", "N", Pass98to18MoreThanOne$NumCauses)
Pass98to18MoreThanOne$Percent <- c(Pass98to18MoreThanOne$count2[1]/sum(Pass98to18MoreThanOne$count2)*100,
                                     Pass98to18MoreThanOne$count2[2]/sum(Pass98to18MoreThanOne$count2)*100,
                                     Pass98to18MoreThanOne$count2[3]/sum(Pass98to18MoreThanOne$count2)*100)
                                     

ggplot(Pass98to18MoreThanOne, aes(x= "", y=Percent, fill=NumCauses)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  scale_fill_viridis(option = "C", discrete = TRUE) +
  theme_void() +
  labs(title = "Number of Causes for Locations Removed 1998 to 2018")
# They are doing a shit job of removing stations with more than one issue

# Number of Causes for Each Location that has been added
Add98to18MoreThanOne <- stationsWorse20yr %>% 
  group_by(DESCRIPTION) %>% 
  summarize(NumCauses=n()) %>%
  na.omit() %>%
  group_by(NumCauses) %>%
  summarize(count2 = n()) 
Add98to18MoreThanOne$NumCauses <- sub("^", "N", Add98to18MoreThanOne$NumCauses)
Add98to18MoreThanOne$Percent <- c(Add98to18MoreThanOne$count2[1]/sum(Add98to18MoreThanOne$count2)*100,
                                   Add98to18MoreThanOne$count2[2]/sum(Add98to18MoreThanOne$count2)*100)


ggplot(Add98to18MoreThanOne, aes(x= "", y=Percent, fill=NumCauses)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  scale_fill_viridis(option = "C", discrete = TRUE) +
  theme_void() +
  labs(title = "Number of Causes for Locations Added 1998 to 2018")

# Stations with a lot of failures
failures <- stationsFail20yr %>% 
  group_by(LOCATION) %>% 
  summarize(NumCauses=n()) %>%
  filter(NumCauses == 8)
```

The goal of these figures is to be able to easily visualize improvements to water bodies over time. The first pie chart shows the fraction of locations which have not been removed over the 20-year period 1998 to 2018. They are grouped by the number of causes which have caused each respective location to be on the list. The majority of locations have made the list due to a single issue, and have remained there for 20 years, however, in four locations over eight issues have persisted. These locations are 1) Magnolia Gardens, a former plantation, 2) Kingston Lake, which is next to a recycling plant, 3) McApline Creek, which is next to a construction facility that specializes in retention walls, 4) Reedy River, which is to the southeast of a wetland (nature's kidneys).The second pie chart shows the fraction of locations which have been removed over the 20-year period. The overwhelming majority of the water bodies have only had one issue to deal with. Water bodies with multiple issues are harder to remediate as they require more complex strategies. The final pie chart shows the fraction of water bodies that have been added over the 20-year period. Most of these water bodies only have one issue - this is likely just a function of increased monitoring of water bodies.

### Darcy's Code
```{r echo = FALSE, warning=FALSE, message=FALSE}

```

### Nick's Code
```{r echo = FALSE, warning=FALSE, message=FALSE}

```